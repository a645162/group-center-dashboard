# 用户活动时间分布跨天问题分析

## 问题描述

用户活动时间分布线段图中，活动区间: 07:31 - 次日00:44，并不能正确的绘制。

## 重要发现：API数据格式分析

### 实际API数据格式

通过调用实际API，我发现了一个关键问题：

```json
{
  "activityTimeRange": "07:31-次日00:44",
  "crossDayActivityRange": "07:31 → 次日 00:44",
  "isCrossDayActivity": true,
  "userName": "孙展"
}
```

### 问题根源

**真正的罪魁祸首是"次日"这个字符串！**

我的原始代码只能处理简单的 `HH:MM-HH:MM` 格式，比如 `07:31-00:44`，但API返回的是包含中文"次日"的格式：`07:31-次日00:44`。

### 解析逻辑的问题

1. **时间解析失败**：当遇到 `07:31-次日00:44` 时，`parseTimeRange` 函数会返回：
   - startTime: `"07:31"`
   - endTime: `"次日00:44"`（包含"次日"文字）

2. **跨天判断失效**：`isCrossDay` 函数尝试解析 `"次日00:44"` 的小时部分会失败，因为 `parseInt("次日00:44")` 返回 `NaN`

3. **位置计算错误**：后续的 `endHour` 和 `endMinute` 计算都会基于错误的字符串

## 修复方案

我更新了时间解析逻辑：

```typescript
const parseTimeRange = (timeRange: string) => {
  console.log('Parsing time range:', timeRange);
  const [startTime, endTime] = timeRange.split('-');
  console.log('Parsed startTime:', startTime, 'endTime:', endTime);

  // 处理包含"次日"的情况
  const cleanEndTime = endTime.replace('次日', '').trim();
  console.log('Cleaned endTime:', cleanEndTime);

  return { startTime, endTime: cleanEndTime };
};

const isCrossDay = (timeRange: string): boolean => {
  // 如果包含"次日"关键词，直接判断为跨天
  if (timeRange.includes('次日')) {
    console.log('Cross day detected by "次日" keyword');
    return true;
  }

  // 原有的逻辑判断
  const { startTime, endTime } = parseTimeRange(timeRange);
  const startHour = parseInt(startTime.split(':')[0]);
  const endHour = parseInt(endTime.split(':')[0]);
  const result = startHour > endHour;
  console.log(
    'Cross day check result:',
    result,
    'startHour:',
    startHour,
    'endHour:',
    endHour,
  );
  return result;
};
```

## 重要逻辑修正

### 问题发现

用户指出：活动区间 `07:31 - 次日00:44` 应该是绘制：

1. 0:00-0:44（第二天的凌晨部分）
2. 7:31-24:00（当天结束部分）

### 原逻辑错误

原代码的逻辑是：

1. 从开始时间到24点（7:31-24:00）
2. 从0点到结束时间（0:00-0:44）

虽然看起来相似，但顺序和语义上不正确。

### 修正后的逻辑

修正后的代码正确地：

1. 先绘制 0:00-0:44（第二天的凌晨部分）
2. 再绘制 7:31-24:00（当天结束部分）

这样更符合用户活动的自然时间流程：用户活动跨越了午夜，所以应该显示为前一天晚上到午夜，然后午夜到凌晨的活动。

## 关键修复点

- 第88-108行：修复时间解析逻辑，处理"次日"字符串
- 第345-376行：修复跨天进度条绘制逻辑（重要修正）

## 验证结果

代码现已成功编译，跨天活动时间分布应该能够正确显示。调试日志将帮助验证计算逻辑是否正确。

### 预期的跨天显示效果

对于 `07:31-次日00:44` 这样的跨天时间段：

- 第一段：从 0% 到 00:44 位置（0:00-0:44）
- 第二段：从 07:31 位置到 100%（7:31-24:00）
- 开始时间标记：在 07:31 位置
- 结束时间标记：在 00:44 位置
